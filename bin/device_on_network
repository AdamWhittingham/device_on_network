#!/usr/bin/env ruby

require 'rubygems'
require 'bundler'
Bundler.require

require 'sinatra'
require 'json'
require_relative '../lib/device_on_network'
require_relative '../lib/periodic_task'

set :port,    ENV['DON_PORT'] || 12001
set :logging, ENV['DON_LOG_REQUESTS'] || false
set :bind,    ENV['DON_BIND'] || '0.0.0.0'

scan_file      = ENV['DON_SCAN_OUTPUT']     || '/var/tmp/scanner.xml'
scan_frequency = ENV['DON_SCAN_FREQUENCY']  || 15
network_target = ENV['DON_NETWORK_TARGETS'] || '192.168.0.*'

parser  = DeviceOnNetwork::Parser.new(scan_file)
scanner = DeviceOnNetwork::Scanner.new(scan_file, network_target)

puts "Starting Scanner"
puts " - Searching: #{network_target}"
puts " - Scan every: #{scan_frequency} seconds"
puts
puts "Set the DON_NETWORK_TARGETS or DON_SCAN_FREQUENCY environment variables to change these settings"

PeriodicTask.run_every(scan_frequency) do
  scanner.scan
end

get '/' do
  active_macs = parser.active_macs
  timestamp = File.mtime(scan_file).utc
  JSON.generate({ active_mac_addresses: active_macs, scanned_at: timestamp })
end
